<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Tale of Peter Rabbit - Interactive Story</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f8fafc;
      width: 100%;
      height: 100%;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
    }
    #story {
      position: relative;
      margin: 0;
      padding: 1em 0;
      width: 100vw;
      max-width: 100vw;
      min-height: 100vh;
      background: #f8fafc;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .story-text {
      font-size: 2.2em;
      font-weight: bold;
      line-height: 1.4;
      letter-spacing: 0.01em;
      color: #222;
      width: 98vw;
      max-width: 98vw;
      margin: 0 auto;
      padding: 0 1vw;
      box-sizing: border-box;
      word-break: break-word;
    }
    .clickable-word {
      text-decoration: underline;
      text-underline-offset: 0.18em;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      border-radius: 0.15em;
      padding: 0 0.07em;
    }
    .highlighted {
      background: #cce8ff !important;
      color: #174c7c !important;
      border-radius: 0.18em;
      transition: background 0.2s, color 0.2s;
    }
    .popup {
      position: absolute;
      left: 1em;
      background: #fff;
      border: 3px solid #1e90ff;
      border-radius: 0.4em;
      box-shadow: 0 7px 32px 0 rgba(30,144,255,0.13), 0 1.5px 5px 0 rgba(30,144,255,0.10);
      z-index: 100;
      min-width: 0;
      max-width: none;
      width: calc(100% - 2em);
      min-height: 2.5em;
      padding: 0.8em 1.2em 1.2em 1.2em;
      font-size: 2em;
      font-weight: bold;
      color: #1e293b;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      overflow: visible;
      text-align: center;
      word-break: break-word;
      animation: popup-appear 0.18s cubic-bezier(.5,1.5,.7,1.1);
    }
    @keyframes popup-appear {
      from { opacity: 0; transform: translateY(24px);}
      to   { opacity: 1; transform: translateY(0);}
    }
    .popup .close-btn {
      position: absolute;
      top: 0.2em;
      right: 0.5em;
      font-size: 1.2em;
      font-weight: bold;
      color: #1e90ff;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 2;
      padding: 0.1em 0.3em;
      border-radius: 0.2em;
      transition: background 0.18s;
    }
    .popup .close-btn:hover {
      background: #e0f2ff;
    }
    .popup .popup-word {
      font-size: 1.25em;
      font-weight: bold;
      margin: 0.3em 0 0.2em 0;
      text-align: center;
      color: #174c7c;
      letter-spacing: 0.01em;
    }
    .popup .popup-sentence {
      font-size: 0.89em;
      font-weight: bold;
      margin: 0.2em 0 0.5em 0;
      color: #1e293b;
      text-align: center;
      width: 100%;
      word-break: break-word;
    }
    .popup .popup-def {
      font-size: 1.05em;
      font-weight: bold;
      margin: 0.3em 0 0.5em 0;
      color: #1e293b;
      text-align: center;
      width: 100%;
      word-break: break-word;
    }
    .popup .popup-examples {
      font-size: 0.95em;
      font-weight: bold;
      color: #222;
      margin: 0.5em 0 0 0;
      width: 100%;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 0.16em;
      word-break: break-word;
    }
    .popup .popup-def-list {
      margin: 0.5em 0 0 0;
      width: 100%;
      max-height: 7em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.18em;
      align-items: stretch;
      justify-content: flex-start;
      text-align: left;
      font-size: 0.98em;
    }
    .popup .popup-def-list .def-option {
      background: #e8f3ff;
      border-radius: 0.18em;
      padding: 0.22em 0.3em;
      margin: 0.07em 0;
      cursor: pointer;
      font-weight: bold;
      color: #174c7c;
      border: 2px solid #1e90ff;
      transition: background 0.14s, color 0.14s;
      text-align: left;
      width: 100%;
      box-sizing: border-box;
      outline: none;
    }
    .popup .popup-def-list .def-option:active,
    .popup .popup-def-list .def-option:hover {
      background: #cce8ff;
      color: #0b2f4a;
    }
    .popup .popup-prompt {
      font-size: 0.93em;
      color: #1e293b;
      text-align: center;
      margin: 0.3em 0 0.2em 0;
      font-weight: bold;
    }
    .popup.secondary-popup {
      background: #f6fbff;
      border: 3px solid #60aaff;
      color: #174c7c;
      z-index: 120;
      font-size: 1.9em;
      padding: 0.7em 1.2em 1.2em 1.2em;
      left: 1em;
      width: calc(100% - 2em);
      box-sizing: border-box;
      animation: popup-appear 0.18s cubic-bezier(.5,1.5,.7,1.1);
    }
    @media (max-width: 600px) {
      .story-text, .popup, .popup.secondary-popup {
        font-size: 2em;
        padding-left: 0.4em;
        padding-right: 0.4em;
      }
      .popup, .popup.secondary-popup {
        left: 0.5em;
        width: calc(100% - 1em);
      }
    }
    ::selection {
      background: #b2e4ff;
    }
  </style>
</head>
<body>
  <div id="story">
    <div class="story-text" id="storyText">
      <span class="clickable-word" data-word="Peter" data-type="word">Peter</span>
      <span class="clickable-word" data-word="hopped" data-type="word">hopped</span>
      <span class="clickable-word" data-word="in" data-type="preposition">in</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="garden" data-type="word">garden</span>,
      <span class="clickable-word" data-word="looking" data-type="word">looking</span>
      <span class="clickable-word" data-word="for" data-type="word">for</span>
      <span class="clickable-word" data-word="something" data-type="word">something</span>
      <span class="clickable-word" data-word="to" data-type="preposition">to</span>
      <span class="clickable-word" data-word="eat" data-type="word">eat</span>.
      <span class="clickable-word" data-word="He" data-type="word">He</span>
      <span class="clickable-word" data-word="squeezed" data-type="word">squeezed</span>
      <span class="clickable-word" data-word="under" data-type="preposition">under</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="gate" data-type="word">gate</span>,
      <span class="clickable-word" data-word="hoping" data-type="word">hoping</span>
      <span class="clickable-word" data-word="to" data-type="preposition">to</span>
      <span class="clickable-word" data-word="find" data-type="word">find</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="snack" data-type="word">snack</span>.
      <span class="clickable-word" data-word="A" data-type="word">A</span>
      <span class="clickable-word" data-word="row" data-type="word">row</span>
      <span class="clickable-word" data-word="of" data-type="preposition">of</span>
      <span class="clickable-word" data-word="carrots" data-type="word">carrots</span>
      <span class="clickable-word" data-word="grew" data-type="word">grew</span>
      <span class="clickable-word" data-word="in" data-type="preposition">in</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="soft" data-type="word">soft</span>
      <span class="clickable-word" data-word="dirt" data-type="word">dirt</span>,
      <span class="clickable-word" data-word="bright" data-type="word">bright</span>
      <span class="clickable-word" data-word="in" data-type="preposition">in</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="morning" data-type="word">morning</span>
      <span class="clickable-word" data-word="sun" data-type="word">sun</span>.
      <span class="clickable-word" data-word="Peter" data-type="word">Peter</span>
      <span class="clickable-word" data-word="nibbled" data-type="word">nibbled</span>
      <span class="clickable-word" data-word="on" data-type="preposition">on</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="leaf" data-type="word">leaf</span>,
      <span class="clickable-word" data-word="feeling" data-type="word">feeling</span>
      <span class="clickable-word" data-word="happy" data-type="word">happy</span>
      <span class="clickable-word" data-word="in" data-type="preposition">in</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="cool" data-type="word">cool</span>
      <span class="clickable-word" data-word="shade" data-type="word">shade</span>.
      <span class="clickable-word" data-word="He" data-type="word">He</span>
      <span class="clickable-word" data-word="saw" data-type="word">saw</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="big" data-type="word">big</span>
      <span class="clickable-word" data-word="cat" data-type="word">cat</span>
      <span class="clickable-word" data-word="sitting" data-type="word">sitting</span>
      <span class="clickable-word" data-word="on" data-type="preposition">on</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="wall" data-type="word">wall</span>,
      <span class="clickable-word" data-word="watching" data-type="word">watching</span>
      <span class="clickable-word" data-word="him" data-type="word">him</span>
      <span class="clickable-word" data-word="from" data-type="preposition">from</span>
      <span class="clickable-word" data-word="above" data-type="word">above</span>.
      <span class="clickable-word" data-word="Peter" data-type="word">Peter</span>
      <span class="clickable-word" data-word="moved" data-type="word">moved</span>
      <span class="clickable-word" data-word="past" data-type="preposition">past</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="cat" data-type="word">cat</span>,
      <span class="clickable-word" data-word="careful" data-type="word">careful</span>
      <span class="clickable-word" data-word="not" data-type="word">not</span>
      <span class="clickable-word" data-word="to" data-type="preposition">to</span>
      <span class="clickable-word" data-word="make" data-type="word">make</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="sound" data-type="word">sound</span>.
      <span class="clickable-word" data-word="He" data-type="word">He</span>
      <span class="clickable-word" data-word="tiptoed" data-type="word">tiptoed</span>
      <span class="clickable-word" data-word="behind" data-type="preposition">behind</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="bush" data-type="word">bush</span>,
      <span class="clickable-word" data-word="hiding" data-type="word">hiding</span>
      <span class="clickable-word" data-word="from" data-type="preposition">from</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="gardener" data-type="word">gardener</span>.
      <span class="clickable-word" data-word="A" data-type="word">A</span>
      <span class="clickable-word" data-word="bird" data-type="word">bird</span>
      <span class="clickable-word" data-word="sang" data-type="word">sang</span>
      <span class="clickable-word" data-word="on" data-type="preposition">on</span>
      <span class="clickable-word" data-word="a" data-type="word">a</span>
      <span class="clickable-word" data-word="branch" data-type="word">branch</span>,
      <span class="clickable-word" data-word="filling" data-type="word">filling</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="air" data-type="word">air</span>
      <span class="clickable-word" data-word="with" data-type="preposition">with</span>
      <span class="clickable-word" data-word="sweet" data-type="word">sweet</span>
      <span class="clickable-word" data-word="music" data-type="word">music</span>.
      <span class="clickable-word" data-word="Peter" data-type="word">Peter</span>
      <span class="clickable-word" data-word="hurried" data-type="word">hurried</span>
      <span class="clickable-word" data-word="through" data-type="preposition">through</span>
      <span class="clickable-word" data-word="the" data-type="word">the</span>
      <span class="clickable-word" data-word="rows" data-type="word">rows</span>,
      <span class="clickable-word" data-word="dreaming" data-type="word">dreaming</span>
      <span class="clickable-word" data-word="of" data-type="preposition">of</span>
      <span class="clickable-word" data-word="home" data-type="word">home</span>
      <span class="clickable-word" data-word="and" data-type="word">and</span>
      <span class="clickable-word" data-word="safety" data-type="word">safety</span>.
    </div>
  </div>
  <script>
    // --- The full JavaScript logic is provided in the previous message ---
    // Please copy and paste the JavaScript code from the previous message here.
    // The code is too long for this message box, but you can copy it directly.
    // It will work as a single HTML file.
// --- Jason dictionary and wordDefinitions omitted here for brevity ---
// Please ensure the full dictionary and wordDefinitions objects are present as in the previous HTML!

// Helper: Get the sentence containing a word node (by traversing siblings)
function getSentenceFromNode(node) {
  let startNode = node, endNode = node;
  while (startNode.previousSibling) {
    if (
      startNode.previousSibling.nodeType === 3 &&
      startNode.previousSibling.textContent.includes('.')
    ) break;
    startNode = startNode.previousSibling;
  }
  while (endNode.nextSibling) {
    if (
      endNode.nextSibling.nodeType === 3 &&
      endNode.nextSibling.textContent.includes('.')
    ) break;
    endNode = endNode.nextSibling;
  }
  let nodes = [];
  let n = startNode;
  while (n !== endNode) {
    nodes.push(n);
    n = n.nextSibling;
  }
  nodes.push(endNode);
  let sent = '';
  nodes.forEach(nn => {
    if (nn.classList && nn.classList.contains('clickable-word')) {
      sent += nn.textContent + ' ';
    } else {
      sent += nn.textContent;
    }
  });
  return sent.trim();
}

// Helper: Underline a word in a sentence (for preposition popup)
function underlineWordInSentence(sentence, word) {
  let regex = new RegExp(`\\b(${word})\\b`, 'i');
  return sentence.replace(regex, '<span style="text-decoration:underline;text-underline-offset:0.18em;">$1</span>');
}

// Helper: Get all definitions for a preposition
function getPrepositionDefinitions(prep) {
  let defs = [];
  if (jasonPrepositions[prep]) {
    for (let grade in jasonPrepositions[prep]) {
      for (let d of jasonPrepositions[prep][grade]) {
        defs.push(d.definition);
      }
    }
  }
  return defs;
}

// Helper: Get all definitions with examples for a preposition
function getPrepositionDefinitionsWithExamples(prep) {
  let defs = [];
  if (jasonPrepositions[prep]) {
    for (let grade in jasonPrepositions[prep]) {
      for (let d of jasonPrepositions[prep][grade]) {
        defs.push({def: d.definition, ex: d.examples});
      }
    }
  }
  return defs;
}

// Helper: If preposition not in Jason, fallback
function getFallbackPrepositionDefinition(prep) {
  const fallback = {
    "past": {
      def: "Moving by or beyond something.",
      ex: [
        "He walked past the house.",
        "The dog ran past the tree.",
        "She went past the store.",
        "The car drove past the school.",
        "The ball rolled past the chair.",
        "The bird flew past the window."
      ]
    },
    "behind": {
      def: "At the back of something.",
      ex: [
        "The cat is behind the couch.",
        "The dog hid behind the door.",
        "She stood behind the tree.",
        "The ball is behind the chair.",
        "The boy is behind the girl.",
        "The car is behind the bus."
      ]
    },
    "with": {
      def: "Having or using something.",
      ex: [
        "She drew with a pencil.",
        "He played with his friend.",
        "The boy ran with the dog.",
        "She ate with a spoon.",
        "He went with his mom.",
        "The girl sang with her sister."
      ]
    },
    "through": {
      def: "In one side and out the other.",
      ex: [
        "He walked through the door.",
        "The bird flew through the window.",
        "She looked through the glass.",
        "The car drove through the tunnel.",
        "The ball rolled through the gate.",
        "The dog ran through the yard."
      ]
    }
  };
  return fallback[prep] || {
    def: "A preposition.",
    ex: [
      "This is a preposition.",
      "It helps show place or time.",
      "We use it in a sentence.",
      "It is a small word.",
      "It helps connect words.",
      "It is important in English."
    ]
  };
}

// Popup logic
let currentPopup = null;
let currentHighlight = null;
let secondaryPopup = null;

function closePopup() {
  if (currentPopup) {
    currentPopup.remove();
    currentPopup = null;
  }
  if (secondaryPopup) {
    secondaryPopup.remove();
    secondaryPopup = null;
  }
  if (currentHighlight) {
    currentHighlight.classList.remove('highlighted');
    currentHighlight = null;
  }
}

function closeSecondaryPopup() {
  if (secondaryPopup) {
    secondaryPopup.remove();
    secondaryPopup = null;
  }
}

// Position the popup below the clicked word, always inside #story
function positionPopup(popup, wordElem) {
  const story = document.getElementById('story');
  const storyRect = story.getBoundingClientRect();
  const wordRect = wordElem.getBoundingClientRect();
  popup.style.width = `calc(${storyRect.width}px - 2em)`;
  popup.style.left = `1em`;
  let top = wordRect.bottom - storyRect.top + 4;
  popup.style.visibility = 'hidden';
  popup.style.display = 'block';
  document.getElementById('story').appendChild(popup);
  let popupRect = popup.getBoundingClientRect();
  let maxTop = storyRect.height - popupRect.height - 8;
  if (top > maxTop) top = Math.max(0, maxTop);
  popup.style.top = `${top}px`;
  popup.style.visibility = 'visible';
  popup.style.display = '';
  popup.remove();
  document.getElementById('story').appendChild(popup);
}

// For secondary popup (preposition definition examples)
function positionSecondaryPopup(popup, defElem, parentPopup) {
  const story = document.getElementById('story');
  const storyRect = story.getBoundingClientRect();
  const defRect = defElem.getBoundingClientRect();
  popup.style.width = `calc(${storyRect.width}px - 2em)`;
  popup.style.left = `1em`;
  let top = defRect.bottom - storyRect.top + 4;
  popup.style.visibility = 'hidden';
  popup.style.display = 'block';
  document.getElementById('story').appendChild(popup);
  let popupRect = popup.getBoundingClientRect();
  let maxTop = storyRect.height - popupRect.height - 8;
  if (top > maxTop) top = Math.max(0, maxTop);
  popup.style.top = `${top}px`;
  popup.style.visibility = 'visible';
  popup.style.display = '';
  popup.remove();
  document.getElementById('story').appendChild(popup);
}

// Main popup for non-prepositions
function showWordPopup(word, wordElem) {
  closePopup();
  wordElem.classList.add('highlighted');
  currentHighlight = wordElem;
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.innerHTML = `
    <button class="close-btn" aria-label="Close Popup">×</button>
    <div class="popup-word">${word}</div>
    <div class="popup-def">${wordDefinitions[word].def}</div>
    <div class="popup-examples">
      <div>${wordDefinitions[word].ex[0]}</div>
      <div>${wordDefinitions[word].ex[1]}</div>
      <div>${wordDefinitions[word].ex[2]}</div>
      <div>${wordDefinitions[word].ex[3]}</div>
      <div>${wordDefinitions[word].ex[4]}</div>
      <div>${wordDefinitions[word].ex[5]}</div>
    </div>
  `;
  popup.querySelector('.close-btn').onclick = closePopup;
  document.getElementById('story').appendChild(popup);
  currentPopup = popup;
  positionPopup(popup, wordElem);
}

// Main popup for prepositions
function showPrepositionPopup(prep, wordElem) {
  closePopup();
  wordElem.classList.add('highlighted');
  currentHighlight = wordElem;
  const popup = document.createElement('div');
  popup.className = 'popup';
  let definitions = getPrepositionDefinitions(prep);
  let defListHtml = '';
  if (definitions.length) {
    definitions.forEach((def, i) => {
      defListHtml += `<div class="def-option" tabindex="0" data-def-index="${i}">${def}</div>`;
    });
  }
  let sent = getSentenceFromNode(wordElem);
  let sentWithUnderline = underlineWordInSentence(sent, prep);
  popup.innerHTML = `
    <button class="close-btn" aria-label="Close Popup">×</button>
    <div class="popup-word">${prep}</div>
    <div class="popup-sentence">${sentWithUnderline}</div>
    <div class="popup-prompt">Pick the best meaning below.</div>
    <div class="popup-def-list">${defListHtml}</div>
  `;
  popup.querySelector('.close-btn').onclick = closePopup;
  document.getElementById('story').appendChild(popup);
  currentPopup = popup;
  positionPopup(popup, wordElem);

  let defsWithExamples = getPrepositionDefinitionsWithExamples(prep);
  let defOptions = popup.querySelectorAll('.def-option');
  defOptions.forEach((defElem, idx) => {
    defElem.onclick = function(e) {
      showPrepositionExamplesPopup(prep, defsWithExamples[idx].def, defsWithExamples[idx].ex, defElem, popup);
    };
    defElem.onkeydown = function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        defElem.click();
      }
    }
  });
}

// Fallback for prepositions not in Jason
function showFallbackPrepositionPopup(prep, wordElem) {
  closePopup();
  wordElem.classList.add('highlighted');
  currentHighlight = wordElem;
  const popup = document.createElement('div');
  popup.className = 'popup';
  let fallback = getFallbackPrepositionDefinition(prep);
  let sent = getSentenceFromNode(wordElem);
  let sentWithUnderline = underlineWordInSentence(sent, prep);
  popup.innerHTML = `
    <button class="close-btn" aria-label="Close Popup">×</button>
    <div class="popup-word">${prep}</div>
    <div class="popup-sentence">${sentWithUnderline}</div>
    <div class="popup-def">${fallback.def}</div>
    <div class="popup-examples">
      <div>${fallback.ex[0]}</div>
      <div>${fallback.ex[1]}</div>
      <div>${fallback.ex[2]}</div>
      <div>${fallback.ex[3]}</div>
      <div>${fallback.ex[4]}</div>
      <div>${fallback.ex[5]}</div>
    </div>
  `;
  popup.querySelector('.close-btn').onclick = closePopup;
  document.getElementById('story').appendChild(popup);
  currentPopup = popup;
  positionPopup(popup, wordElem);
}

// Second popup for preposition definition examples
function showPrepositionExamplesPopup(prep, def, examples, defElem, parentPopup) {
  closeSecondaryPopup();
  const popup = document.createElement('div');
  popup.className = 'popup secondary-popup';
  popup.innerHTML = `
    <button class="close-btn" aria-label="Close Popup">×</button>
    <div class="popup-word">${prep}</div>
    <div class="popup-def">${def}</div>
    <div class="popup-examples">
      <div>${examples[0].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
      <div>${examples[1].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
      <div>${examples[2].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
      <div>${examples[3].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
      <div>${examples[4].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
      <div>${examples[5].replace(new RegExp(`\\b${prep}\\b`, 'gi'), `<span style="text-decoration:underline;text-underline-offset:0.18em;">${prep}</span>`)}</div>
    </div>
  `;
  popup.querySelector('.close-btn').onclick = closeSecondaryPopup;
  document.getElementById('story').appendChild(popup);
  secondaryPopup = popup;
  positionSecondaryPopup(popup, defElem, parentPopup);
}

// Click event for all underlined words
document.getElementById('story').addEventListener('click', function(e) {
  let target = e.target;
  if (target.classList.contains('clickable-word')) {
    let word = target.getAttribute('data-word');
    let type = target.getAttribute('data-type');
    if (type === 'preposition') {
      if (jasonPrepositions[word]) {
        showPrepositionPopup(word, target);
      } else {
        showFallbackPrepositionPopup(word, target);
      }
    } else {
      showWordPopup(word, target);
    }
  }
});

// Close popup on outside click
document.addEventListener('click', function(e) {
  if (
    currentPopup &&
    !currentPopup.contains(e.target) &&
    (!secondaryPopup || !secondaryPopup.contains(e.target)) &&
    !(e.target.classList && e.target.contains('clickable-word'))
  ) {
    closePopup();
  }
}, true);

// Close popup on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closePopup();
    closeSecondaryPopup();
  }
});

  </script>
</body>
</html>
