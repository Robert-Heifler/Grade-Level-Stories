<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Tale of Peter Rabbit - Grade 2 Story</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    #story {
      margin: 32px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
      padding: 32px 16px 48px 16px;
      max-width: 700px;
      min-width: 0;
      width: 98vw;
      position: relative;
      overflow: auto;
    }
    .story-text {
      font-size: 2.2em;
      font-weight: bold;
      line-height: 1.45;
      color: #222;
      word-break: break-word;
    }
    .clickable-word {
      border-bottom: 3px solid #3a8dde;
      cursor: pointer;
      transition: background 0.2s;
      padding: 0 0.05em;
      border-radius: 4px;
      position: relative;
    }
    .highlighted {
      background: #cde7fd;
      color: #124a7c;
    }
    .popup {
      position: absolute;
      z-index: 100;
      background: #fafdff;
      border: 2px solid #3a8dde;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(30,80,160,0.15);
      padding: 0 0 24px 0;
      min-width: 220px;
      max-width: none;
      width: 98%;
      left: 1%;
      font-size: 1.1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: box-shadow 0.2s;
      overflow: visible;
    }
    .popup-header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      width: 100%;
      padding: 8px 18px 0 0;
      min-height: 36px;
    }
    .popup-close {
      font-size: 1.4em;
      font-weight: bold;
      color: #3a8dde;
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      margin-left: auto;
      padding: 0 0 0 20px;
      transition: color 0.2s;
    }
    .popup-close:hover {
      color: #e14b4b;
    }
    .popup-title {
      font-weight: bold;
      text-align: center;
      width: 100%;
      font-size: 1.2em;
      margin: 0 0 8px 0;
      color: #124a7c;
      letter-spacing: 0.01em;
    }
    .popup-definition {
      font-weight: bold;
      text-align: left;
      margin: 0 20px 12px 20px;
      color: #222;
    }
    .popup-examples {
      margin: 0 20px;
      padding: 0;
      list-style-type: disc;
    }
    .popup-examples li {
      margin: 0 0 8px 0;
      font-size: 1em;
      color: #333;
      padding-left: 0.2em;
    }
    .popup-prep-list {
      margin: 0 20px 0 20px;
      padding: 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .prep-def-item {
      background: #eaf4ff;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 1em;
      cursor: pointer;
      border: 2px solid #cde7fd;
      transition: background 0.15s, border 0.15s;
      position: relative;
    }
    .prep-def-item:hover, .prep-def-item.selected {
      background: #cde7fd;
      border: 2px solid #3a8dde;
    }
    .popup-secondary {
      position: absolute;
      z-index: 101;
      background: #fafdff;
      border: 2px solid #3a8dde;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(30,80,160,0.18);
      padding: 0 0 24px 0;
      width: 98%;
      left: 1%;
      font-size: 1.1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: box-shadow 0.2s;
      overflow: visible;
    }
    @media (max-width: 600px) {
      #story {
        padding: 18px 2vw 36px 2vw;
      }
      .story-text {
        font-size: 2em;
      }
      .popup, .popup-secondary {
        padding-bottom: 20px;
        font-size: 1em;
      }
    }
    @media (max-width: 400px) {
      .story-text {
        font-size: 1.45em;
      }
      .popup, .popup-secondary {
        font-size: 0.95em;
      }
    }
  </style>
</head>
<body>
  <div id="story">
    <div class="story-text" id="storyText">
      <span class="clickable-word" data-word="Peter">Peter</span> <span class="clickable-word" data-word="hopped">hopped</span> <span class="clickable-word" data-word="in">in</span> the <span class="clickable-word" data-word="garden">garden</span>, looking for something to <span class="clickable-word" data-word="eat">eat</span>. He <span class="clickable-word" data-word="squeezed">squeezed</span> <span class="clickable-word" data-word="under">under</span> the <span class="clickable-word" data-word="gate">gate</span>, hoping to find a <span class="clickable-word" data-word="snack">snack</span>. A row of <span class="clickable-word" data-word="carrots">carrots</span> grew <span class="clickable-word" data-word="in">in</span> the soft <span class="clickable-word" data-word="dirt">dirt</span>, bright <span class="clickable-word" data-word="in">in</span> the morning <span class="clickable-word" data-word="sun">sun</span>. <span class="clickable-word" data-word="Peter">Peter</span> <span class="clickable-word" data-word="nibbled">nibbled</span> <span class="clickable-word" data-word="on">on</span> a <span class="clickable-word" data-word="leaf">leaf</span>, feeling happy <span class="clickable-word" data-word="in">in</span> the cool <span class="clickable-word" data-word="shade">shade</span>. He saw a big <span class="clickable-word" data-word="cat">cat</span> sitting <span class="clickable-word" data-word="on">on</span> a <span class="clickable-word" data-word="wall">wall</span>, watching him <span class="clickable-word" data-word="from">from</span> above. <span class="clickable-word" data-word="Peter">Peter</span> moved <span class="clickable-word" data-word="past">past</span> the <span class="clickable-word" data-word="cat">cat</span>, careful not to make a sound. He tiptoed <span class="clickable-word" data-word="behind">behind</span> a <span class="clickable-word" data-word="bush">bush</span>, hiding <span class="clickable-word" data-word="from">from</span> the <span class="clickable-word" data-word="gardener">gardener</span>. A <span class="clickable-word" data-word="bird">bird</span> sang <span class="clickable-word" data-word="on">on</span> a <span class="clickable-word" data-word="branch">branch</span>, filling the air <span class="clickable-word" data-word="with">with</span> sweet <span class="clickable-word" data-word="music">music</span>. <span class="clickable-word" data-word="Peter">Peter</span> hurried <span class="clickable-word" data-word="through">through</span> the rows, dreaming <span class="clickable-word" data-word="of">of</span> home and safety.
    </div>
  </div>
  <script>
    // Preposition dictionary (Jason format, sorted by grade level)
    const prepositionDict = {
      "in": [
        {
          grade: 1,
          definition: "Inside a place or thing.",
          examples: [
            "The cat is in the box.",
            "We sit in the car.",
            "He hid in the closet.",
            "She put her toy in the bag.",
            "The dog sleeps in the house.",
            "There is milk in the cup."
          ]
        },
        {
          grade: 2,
          definition: "During a period of time.",
          examples: [
            "We play in the morning.",
            "The party is in July.",
            "He reads in the afternoon.",
            "It snows in winter.",
            "We eat in the evening.",
            "They swim in summer."
          ]
        }
      ],
      "on": [
        {
          grade: 1,
          definition: "Resting or touching the surface of something.",
          examples: [
            "The book is on the table.",
            "She sits on the chair.",
            "The cat sleeps on the bed.",
            "There is a hat on his head.",
            "The cup is on the shelf.",
            "He stands on the floor."
          ]
        },
        {
          grade: 2,
          definition: "About a topic or subject.",
          examples: [
            "We read a book on animals.",
            "She gave a talk on plants.",
            "He watched a show on TV.",
            "They learned on the computer.",
            "We worked on math.",
            "She drew a picture on paper."
          ]
        }
      ],
      "under": [
        {
          grade: 1,
          definition: "Below or beneath something.",
          examples: [
            "The dog is under the table.",
            "He hid under the bed.",
            "The ball rolled under the chair.",
            "She found a coin under the rug.",
            "The cat sleeps under the tree.",
            "There is dust under the couch."
          ]
        }
      ],
      "from": [
        {
          grade: 1,
          definition: "Starting at a place or person.",
          examples: [
            "She came from school.",
            "The letter is from Mom.",
            "He ran from the park.",
            "The gift is from Dad.",
            "We walked from home.",
            "The sound comes from the radio."
          ]
        }
      ],
      "past": [
        {
          grade: 2,
          definition: "Going by or beyond something.",
          examples: [
            "He walked past the store.",
            "The car drove past my house.",
            "We ran past the playground.",
            "She looked past the trees.",
            "The bird flew past the window.",
            "They went past the gate."
          ]
        }
      ],
      "behind": [
        {
          grade: 1,
          definition: "At the back of something.",
          examples: [
            "The dog is behind the door.",
            "She stands behind her friend.",
            "The ball is behind the chair.",
            "He hides behind the tree.",
            "The cat is behind the box.",
            "We sit behind the desk."
          ]
        }
      ],
      "with": [
        {
          grade: 1,
          definition: "Together or having something.",
          examples: [
            "She plays with her dog.",
            "He eats with a spoon.",
            "We go with Mom.",
            "They sing with friends.",
            "I draw with a pencil.",
            "She runs with her brother."
          ]
        }
      ],
      "through": [
        {
          grade: 2,
          definition: "Moving in one side and out the other.",
          examples: [
            "He walked through the door.",
            "The ball rolled through the tunnel.",
            "We drove through the city.",
            "She looked through the window.",
            "The wind blew through the trees.",
            "They ran through the field."
          ]
        }
      ],
      "of": [
        {
          grade: 1,
          definition: "Belonging to or about something.",
          examples: [
            "A piece of cake.",
            "The color of the sky.",
            "A bag of apples.",
            "The sound of music.",
            "A group of kids.",
            "The smell of flowers."
          ]
        }
      ]
    };

    // Definitions and examples for other underlined words/idioms/contractions
    const wordDict = {
      "Peter": {
        definition: "A rabbit who is the main character in the story.",
        examples: [
          "Peter is a little rabbit.",
          "Peter wears a blue jacket.",
          "Peter likes to explore.",
          "Peter is very curious.",
          "Peter has many adventures.",
          "Peter lives with his family."
        ]
      },
      "hopped": {
        definition: "Jumped forward with both feet together, like a rabbit.",
        examples: [
          "The frog hopped on the grass.",
          "She hopped over the puddle.",
          "The bunny hopped away.",
          "He hopped to the door.",
          "The bird hopped on the branch.",
          "They hopped in the game."
        ]
      },
      "garden": {
        definition: "A place where people grow plants, flowers, or vegetables.",
        examples: [
          "We have a garden at home.",
          "The garden has many flowers.",
          "He waters the garden.",
          "She picks carrots in the garden.",
          "The rabbit runs in the garden.",
          "Birds sing in the garden."
        ]
      },
      "eat": {
        definition: "To put food in your mouth and chew it.",
        examples: [
          "We eat lunch at noon.",
          "The dog likes to eat.",
          "She will eat an apple.",
          "He wants to eat cake.",
          "They eat together.",
          "I eat breakfast every day."
        ]
      },
      "squeezed": {
        definition: "Pushed through a small space with effort.",
        examples: [
          "The mouse squeezed through the hole.",
          "She squeezed into her seat.",
          "He squeezed past the crowd.",
          "The cat squeezed under the fence.",
          "They squeezed through the door.",
          "The puppy squeezed behind the chair."
        ]
      },
      "gate": {
        definition: "A door or opening in a fence or wall.",
        examples: [
          "The gate is open.",
          "He closed the gate.",
          "She walked through the gate.",
          "The dog ran out the gate.",
          "They painted the gate red.",
          "The gate leads to the garden."
        ]
      },
      "snack": {
        definition: "A small amount of food eaten between meals.",
        examples: [
          "I had a snack after school.",
          "She eats a snack at break time.",
          "He brought a snack for the trip.",
          "We shared a snack.",
          "The snack was an apple.",
          "They packed a snack for the hike."
        ]
      },
      "carrots": {
        definition: "Orange vegetables that grow in the ground.",
        examples: [
          "Rabbits like to eat carrots.",
          "She picked carrots from the garden.",
          "He cut the carrots for soup.",
          "Carrots are good for your eyes.",
          "We bought carrots at the store.",
          "The carrots are sweet and crunchy."
        ]
      },
      "dirt": {
        definition: "Soil or earth found on the ground.",
        examples: [
          "The plant grows in dirt.",
          "He played in the dirt.",
          "She dug a hole in the dirt.",
          "The dirt was soft and brown.",
          "We found worms in the dirt.",
          "The dog rolled in the dirt."
        ]
      },
      "sun": {
        definition: "The bright star in the sky that gives us light and warmth.",
        examples: [
          "The sun is shining.",
          "We play in the sun.",
          "The sun rises in the morning.",
          "She wears a hat in the sun.",
          "The sun sets at night.",
          "Plants need sun to grow."
        ]
      },
      "nibbled": {
        definition: "Ate something in small bites.",
        examples: [
          "The mouse nibbled on cheese.",
          "She nibbled a cookie.",
          "He nibbled the carrot.",
          "The rabbit nibbled the leaf.",
          "They nibbled on snacks.",
          "The bird nibbled the seed."
        ]
      },
      "leaf": {
        definition: "A flat, green part of a plant or tree.",
        examples: [
          "The leaf fell from the tree.",
          "She picked up a leaf.",
          "The leaf is green.",
          "A bug sits on the leaf.",
          "Leaves grow in spring.",
          "He drew a leaf."
        ]
      },
      "shade": {
        definition: "A cool, dark place out of the sun.",
        examples: [
          "We sat in the shade.",
          "The tree gives shade.",
          "The dog sleeps in the shade.",
          "She found shade under the umbrella.",
          "It is cooler in the shade.",
          "He rested in the shade."
        ]
      },
      "cat": {
        definition: "A small animal with fur, whiskers, and a tail.",
        examples: [
          "The cat is soft and furry.",
          "She has a pet cat.",
          "The cat chased the mouse.",
          "He fed the cat.",
          "The cat climbed the tree.",
          "Cats like to nap."
        ]
      },
      "wall": {
        definition: "A flat, upright structure that forms the side of a room or building.",
        examples: [
          "The picture hangs on the wall.",
          "He painted the wall blue.",
          "She leaned against the wall.",
          "The wall is tall.",
          "They built a wall.",
          "The ball hit the wall."
        ]
      },
      "bush": {
        definition: "A low plant with many small branches and leaves.",
        examples: [
          "The bird sits in the bush.",
          "She hid behind the bush.",
          "The bush has red berries.",
          "He trimmed the bush.",
          "The rabbit ran past the bush.",
          "We planted a bush."
        ]
      },
      "gardener": {
        definition: "A person who takes care of a garden.",
        examples: [
          "The gardener waters the plants.",
          "She is a good gardener.",
          "The gardener plants flowers.",
          "He works as a gardener.",
          "The gardener pulls weeds.",
          "They hired a gardener."
        ]
      },
      "bird": {
        definition: "An animal with wings and feathers that can usually fly.",
        examples: [
          "The bird sings in the tree.",
          "She saw a red bird.",
          "Birds build nests.",
          "He feeds the bird.",
          "The bird flies high.",
          "We watched the bird."
        ]
      },
      "branch": {
        definition: "A part of a tree that grows out from the trunk.",
        examples: [
          "The bird sits on a branch.",
          "He climbed the branch.",
          "Leaves grow on the branch.",
          "She broke a branch.",
          "The branch is long.",
          "A squirrel ran on the branch."
        ]
      },
      "music": {
        definition: "Pleasant sounds made by singing or playing instruments.",
        examples: [
          "She likes to listen to music.",
          "He played music on the piano.",
          "The music is loud.",
          "We dance to music.",
          "Birds make music in the morning.",
          "Music makes me happy."
        ]
      },
      "hurried": {
        definition: "Moved quickly because of being in a rush.",
        examples: [
          "He hurried to school.",
          "She hurried home.",
          "They hurried to the bus.",
          "The cat hurried away.",
          "We hurried to the store.",
          "He hurried to finish his work."
        ]
      }
    };

    // Helper: Is this word a preposition in our dictionary?
    function isPreposition(word) {
      return prepositionDict.hasOwnProperty(word);
    }

    // Helper: Capitalize first letter
    function cap(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Remove any existing popups and highlights
    function closeAllPopups() {
      document.querySelectorAll('.popup, .popup-secondary').forEach(el => el.remove());
      document.querySelectorAll('.highlighted').forEach(el => el.classList.remove('highlighted'));
    }

    // Position the popup relative to the story block and clicked word
    function positionPopup(popup, wordElem, storyElem) {
      // Get bounding rects
      const wordRect = wordElem.getBoundingClientRect();
      const storyRect = storyElem.getBoundingClientRect();

      // Calculate top: one line below the word, but inside #story
      // All coordinates are relative to the viewport, so subtract storyRect.top
      const lineHeight = parseFloat(getComputedStyle(wordElem).lineHeight) || wordRect.height * 1.1;
      let top = wordRect.bottom - storyRect.top + lineHeight * 0.15;

      // Ensure popup fits inside #story vertically
      let popupHeight = popup.offsetHeight || 260; // fallback if not rendered yet
      let maxTop = storyElem.offsetHeight - popupHeight - 12;
      if (top > maxTop) top = Math.max(8, maxTop);

      popup.style.top = `${top}px`;
      popup.style.left = `1%`;
      popup.style.width = `98%`;
      popup.style.maxWidth = `none`;
    }

    // Position secondary popup (for preposition examples)
    function positionSecondaryPopup(popup, storyElem) {
      popup.style.top = `8%`;
      popup.style.left = `1%`;
      popup.style.width = `98%`;
      popup.style.maxWidth = `none`;
    }

    // Show popup for a regular word
    function showWordPopup(word, wordElem, storyElem) {
      closeAllPopups();
      wordElem.classList.add('highlighted');
      const entry = wordDict[word];
      if (!entry) return;
      const popup = document.createElement('div');
      popup.className = 'popup';

      // Close button
      const header = document.createElement('div');
      header.className = 'popup-header';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'popup-close';
      closeBtn.innerText = '✕';
      closeBtn.onclick = () => closeAllPopups();
      header.appendChild(closeBtn);

      // Title
      const title = document.createElement('div');
      title.className = 'popup-title';
      title.innerText = cap(word);
      popup.appendChild(header);
      popup.appendChild(title);

      // Definition
      const def = document.createElement('div');
      def.className = 'popup-definition';
      def.innerText = entry.definition;
      popup.appendChild(def);

      // Examples
      const ul = document.createElement('ul');
      ul.className = 'popup-examples';
      entry.examples.forEach(ex => {
        const li = document.createElement('li');
        li.innerText = ex;
        ul.appendChild(li);
      });
      popup.appendChild(ul);

      storyElem.appendChild(popup);
      setTimeout(() => positionPopup(popup, wordElem, storyElem), 0);
    }

    // Show popup for a preposition (list all definitions, sorted)
    function showPrepositionPopup(word, wordElem, storyElem) {
      closeAllPopups();
      wordElem.classList.add('highlighted');
      let defs = prepositionDict[word];
      if (!defs || !defs.length) return;
      // Sort by grade
      defs = defs.slice().sort((a, b) => a.grade - b.grade);

      const popup = document.createElement('div');
      popup.className = 'popup';

      // Close button
      const header = document.createElement('div');
      header.className = 'popup-header';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'popup-close';
      closeBtn.innerText = '✕';
      closeBtn.onclick = () => closeAllPopups();
      header.appendChild(closeBtn);

      // Title
      const title = document.createElement('div');
      title.className = 'popup-title';
      title.innerText = cap(word);
      popup.appendChild(header);
      popup.appendChild(title);

      // List all definitions
      const defList = document.createElement('div');
      defList.className = 'popup-prep-list';
      defs.forEach((defObj, idx) => {
        const item = document.createElement('div');
        item.className = 'prep-def-item';
        item.innerHTML = `<b>Grade ${defObj.grade}:</b> ${defObj.definition}`;
        item.onclick = (e) => {
          e.stopPropagation();
          showPrepositionExamplesPopup(word, defObj, storyElem, popup);
          // Mark selected
          defList.querySelectorAll('.prep-def-item').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
        };
        defList.appendChild(item);
      });
      popup.appendChild(defList);

      storyElem.appendChild(popup);
      setTimeout(() => positionPopup(popup, wordElem, storyElem), 0);
    }

    // Show popup for preposition examples (secondary popup)
    function showPrepositionExamplesPopup(word, defObj, storyElem, parentPopup) {
      // Remove any other secondary popups
      document.querySelectorAll('.popup-secondary').forEach(el => el.remove());

      const popup = document.createElement('div');
      popup.className = 'popup-secondary';

      // Close button
      const header = document.createElement('div');
      header.className = 'popup-header';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'popup-close';
      closeBtn.innerText = '✕';
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        popup.remove();
        // Unselect all
        parentPopup.querySelectorAll('.prep-def-item').forEach(el => el.classList.remove('selected'));
      };
      header.appendChild(closeBtn);

      // Title
      const title = document.createElement('div');
      title.className = 'popup-title';
      title.innerText = `${cap(word)} - Grade ${defObj.grade}`;
      popup.appendChild(header);
      popup.appendChild(title);

      // Definition
      const def = document.createElement('div');
      def.className = 'popup-definition';
      def.innerText = defObj.definition;
      popup.appendChild(def);

      // Examples
      const ul = document.createElement('ul');
      ul.className = 'popup-examples';
      defObj.examples.forEach(ex => {
        const li = document.createElement('li');
        li.innerText = ex;
        ul.appendChild(li);
      });
      popup.appendChild(ul);

      storyElem.appendChild(popup);
      setTimeout(() => positionSecondaryPopup(popup, storyElem), 0);
    }

    // Main event handler for word clicks
    function onWordClick(e) {
      e.stopPropagation();
      const wordElem = e.target;
      const word = (wordElem.dataset.word || '').toLowerCase();
      const storyElem = document.getElementById('story');
      if (!word) return;
      if (isPreposition(word)) {
        showPrepositionPopup(word, wordElem, storyElem);
      } else if (wordDict[word]) {
        showWordPopup(word, wordElem, storyElem);
      }
    }

    // Attach click handlers to all clickable words
    function attachWordHandlers() {
      document.querySelectorAll('.clickable-word').forEach(el => {
        el.addEventListener('click', onWordClick);
      });
    }

    // Close popups on click outside
    document.body.addEventListener('click', function(e) {
      if (!e.target.classList.contains('clickable-word')) {
        closeAllPopups();
      }
    });

    // Prevent popup click from closing
    document.getElementById('story').addEventListener('click', function(e) {
      if (e.target.classList.contains('popup-close') ||
          e.target.classList.contains('prep-def-item') ||
          e.target.classList.contains('clickable-word')) {
        // handled elsewhere
        return;
      }
      // Don't close when clicking inside popup
      if (e.target.closest('.popup') || e.target.closest('.popup-secondary')) {
        e.stopPropagation();
        return;
      }
      closeAllPopups();
    });

    // On load
    window.onload = function() {
      attachWordHandlers();
    };
  </script>
</body>
</html>
